#summary AddressSanitizer for Linux kernel.

= Overview =

A dynamic memory error detector for Linux kernel.
Currently works only on x86_64, supports only SLAB allocator.

AddressSanitizer for Linux kernel:
 * Is based on compiler instrumentation (fast)
 * Detects OOB for both writes and reads
 * Provides strong UAF detection (based on delayed memory reuse)
 * Does prompt detection of bad memory accesses
 * Prints informative reports

= Details =

Pre-alpha repository: https://github.com/xairy/linux

More extensive documentation: https://github.com/xairy/linux/blob/asan/Documentation/asan.txt

== Reports ==

To simplify reading the reports you can use our [https://code.google.com/p/address-sanitizer/source/browse/trunk/tools/kasan_symbolize.py symbolizer script]:
{{{
$ cat ./report
...
[  107.327411]  [<ffffffff8110424c>] call_usermodehelper_freeinfo+0x2c/0x30
[  107.328668]  [<ffffffff811049d5>] call_usermodehelper_exec+0xa5/0x1c0
[  107.329816]  [<ffffffff811052b0>] call_usermodehelper+0x40/0x60
[  107.330987]  [<ffffffff8146c15e>] kobject_uevent_env+0x5ee/0x620
[  107.332035]  [<ffffffff8146c19b>] kobject_uevent+0xb/0x10
[  107.333108]  [<ffffffff8173bd7f>] net_rx_queue_update_kobjects+0xaf/0x150
...
}}}
{{{
$ cat ./report | ./kasan_symbolize.py ./vmlinux
...
 [<ffffffff8110424c>] call_usermodehelper_freeinfo+0x2c/0x30 ./kernel/kmod.c:265
 [<ffffffff811049d5>] call_usermodehelper_exec+0xa5/0x1c0 ./kernel/kmod.c:612
 [<ffffffff811052b0>] call_usermodehelper+0x40/0x60 ./kernel/kmod.c:642
 [<ffffffff8146c15e>] kobject_uevent_env+0x5ee/0x620 ./lib/kobject_uevent.c:311
 [<ffffffff8146c19b>] kobject_uevent+0xb/0x10 ./lib/kobject_uevent.c:333
 [<     inlined    >] net_rx_queue_update_kobjects+0xaf/0x150 rx_queue_add_kobject ./net/core/net-sysfs.c:771
 [<ffffffff8173bd7f>] net_rx_queue_update_kobjects+0xaf/0x150 ./net/core/net-sysfs.c:786
...
}}}

== Instrumentation ==

To instrument the kernel you need to use a custom GCC, which you can download [https://address-sanitizer.googlecode.com/files/gcc-r203101-snapshot.tar.gz here].

You need to set GCC path in the make command line:
{{{
make CC='$GCC_KASAN/bin/gcc'
}}}

You will also need to enable SLAB allocator (General setup > Choose SLAB allocator) and AddressSanitizer (Kernel hacking > Memory Debugging) during kernel configuration.

If you would like to build GCC yourself read the instructions below.

Checkout GCC:
{{{
svn checkout -r 203101 svn://gcc.gnu.org/svn/gcc/trunk $GCC_KASAN
}}}

Apply [https://address-sanitizer.googlecode.com/files/gcc-r203101-kasan.patch this patch] to GCC:
{{{
cd $GCC_KASAN
patch -p0 -i gcc-r203101-kasan.patch
}}}

Install GCC prerequisites:
{{{
sudo apt-get install flex bison libc6-dev libc6-dev-i386 libgmp3-dev libmpfr-dev libmpc-dev
}}}

Build GCC:
{{{
cd $GCC_KASAN
mkdir build
mkdir install
cd build
../configure --enable-languages=c,c++ --disable-bootstrap --enable-checking=no --with-gnu-as --with-gnu-ld --with-ld=/usr/bin/ld.bfd --prefix=$GCC_KASAN/install
make
make install
}}}

= Trophies =

*Fixed:*
 * Out-of-bounds read in net/ipv4:
http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=aab515d7c32a34300312416c50314e755ea6f765

 * Out-of-bounds in sd_revalidate_disk (drivers/scsi/sd.c):
http://www.spinics.net/lists/linux-scsi/msg68519.html

http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=984f1733fcee3fbc78d47e26c5096921c5d9946a

 * Use-after-free in aio_migratepage:
Sent to  linux-aio mainling list, not visible on web.

https://code.google.com/p/address-sanitizer/wiki/AddressSanitizerForKernelReports

http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=5e9ae2e5da0beb93f8557fc92a8f4fbc05ea448f

 * Out-of-bounds in ip6_finish_output2:
http://www.spinics.net/lists/netdev/msg250734.html

http://seclists.org/oss-sec/2013/q3/683

http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=2811ebac2521ceac84f2bdae402455baa6a7fb47

http://www.spinics.net/lists/netdev/msg282080.html

  * Out-of-bounds in ftrace_regex_release (kernel/trace/ftrace.c):
http://www.spinics.net/lists/kernel/msg1612400.html

https://lkml.org/lkml/2013/10/20/126

 * Use-after-free in ext4_mb_new_blocks:

http://permalink.gmane.org/gmane.comp.file-systems.ext4/40353

http://permalink.gmane.org/gmane.comp.file-systems.ext4/41108

*Confirmed:*

 * Race (use-after-free) in ip4_datagram_release_cb:
http://www.spinics.net/lists/netdev/msg285419.html

 * Use-after-free in __put_anon_vma:
https://lkml.org/lkml/2014/6/6/186

 * Out-of-bounds read in __d_lookup_rcu (fs/dcache.c):
https://code.google.com/p/address-sanitizer/wiki/AddressSanitizerForKernelReports

http://lkml.org/lkml/2013/10/3/493

 * Out-of-bounds in get_wchan (arch/x86/kernel/process_64.c):
http://www.lkml.org/lkml/2013/9/3/286

*Not confirmed:*
 * Use-after-free in drivers/net/ethernet/intel/e1000:
http://permalink.gmane.org/gmane.linux.drivers.e1000.devel/12441
 * Use-after-free in ____call_usermodehelper (kernel/kmod.c):
http://www.lkml.org/lkml/2013/8/21/431
 * Use-after-free in SyS_remap_file_pages:
https://lkml.org/lkml/2013/9/17/30
  * Use-after-free in ata_qc_issue (drivers/ata/libata-core.c):
http://www.spinics.net/lists/linux-ide/msg46213.html